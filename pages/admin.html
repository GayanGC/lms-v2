<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - EduLMS</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link href="../assets/css/modern-theme.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="dark-app">
    <aside class="sidebar glass d-flex flex-column">
      <div class="brand mb-3">
        <i class="fas fa-user-shield text-info"></i>
        <h5 class="m-0">Admin Panel</h5>
      </div>
      <nav class="flex-grow-1">
        <a href="./admin.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
        <a href="./admin_users.html" class="nav-link"><i class="fas fa-users"></i> Users</a>
        <a href="./admin_courses.html" class="nav-link"><i class="fas fa-book"></i> Courses</a>
        <a href="./admin_notifications.html" class="nav-link"><i class="fas fa-bell"></i> Notifications</a>
        <a href="./admin_profile.html" class="nav-link"><i class="fas fa-id-badge"></i> Profile</a>
      </nav>
      <button class="btn btn-ghost w-100 mt-auto" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </aside>

    <!-- Topbar -->
    <header class="topbar glass">
      <div class="d-flex align-items-center gap-2">
        <span class="gradient-text fw-bold">EduLMS</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-ghost btn-sm"><i class="fa-regular fa-bell"></i></button>
        <img class="avatar" src="https://api.dicebear.com/7.x/initials/svg?seed=AD" alt="avatar" />
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="fw-bold">Admin Dashboard</h2>
          <p class="text-secondary">Welcome back, <span id="adminName" class="gradient-text fw-semibold">Admin</span></p>
        </div>
        <span class="badge badge-status badge-approved">System Administrator</span>
      </div>
      <hr class="divider" />

      <!-- Metrics -->
      <section class="metrics-grid row mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card-modern metric-card p-3">
            <div class="metric-bg"></div>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="metric-label">Total Users</div>
                <div id="totalUsersMetric" class="metric-value">—</div>
              </div>
              <i class="fa-solid fa-users text-info"></i>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card-modern metric-card p-3">
            <div class="metric-bg"></div>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="metric-label">Revenue</div>
                <div id="revenueMetric" class="metric-value">—</div>
              </div>
              <i class="fa-solid fa-coins text-warning"></i>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card-modern metric-card p-3">
            <div class="metric-bg"></div>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="metric-label">Active Courses</div>
                <div id="activeCoursesMetric" class="metric-value">—</div>
              </div>
              <i class="fa-solid fa-book-open text-primary"></i>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card-modern metric-card p-3">
            <div class="metric-bg"></div>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="metric-label">Instructors</div>
                <div id="instructorsMetric" class="metric-value">—</div>
              </div>
              <i class="fa-solid fa-chalkboard-user text-purple"></i>
            </div>
          </div>
        </div>
      </section>

      <!-- Pending Approvals -->
      <section id="pendingSection" class="mb-4">
        <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Pending Approvals</h5>
        <div class="card-modern p-3">
          <div class="table-responsive">
            <table class="table table-dark-modern table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Registered</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="pendingTableBody">
                <tr>
                  <td colspan="6" class="text-center text-secondary py-3">Loading pending users…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Analytics -->
      <section id="analyticsSection">
        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Analytics</h5>
        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <div class="card-modern chart-card">
              <h6 class="text-secondary mb-2">Revenue (Monthly)</h6>
              <div class="chart-container">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-5">
            <div class="card-modern chart-card">
              <h6 class="text-secondary mb-2">User Distribution</h6>
              <div class="chart-container" style="height: 280px;">
                <canvas id="userDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      // Auth check & display name
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser || currentUser.role !== 'admin') {
        window.location.href = '../login.html';
      } else {
        document.getElementById('adminName').textContent = currentUser.name;
      }

      document.addEventListener('DOMContentLoaded', loadAdminData);

      async function loadAdminData() {
        try {
          const [dashRes, analyticsRes] = await Promise.all([
            fetch('../backend/admin_dashboard_data.php'),
            fetch('../backend/admin_analytics.php')
          ]);
          const dash = await dashRes.json();
          const analytics = await analyticsRes.json();

          if (dash.status === 'success') {
            const stats = dash.data.stats || {};
            const totalUsers = (parseInt(stats.total_students || 0) + parseInt(stats.total_instructors || 0));
            document.getElementById('totalUsersMetric').textContent = totalUsers.toLocaleString();
            document.getElementById('instructorsMetric').textContent = parseInt(stats.total_instructors || 0).toLocaleString();
            // Active courses: if available later, set; for now show pending count as proxy
            document.getElementById('activeCoursesMetric').textContent = (stats.total_pending || 0).toLocaleString();

            renderPendingTable(dash.data.pending_users || []);
            renderUserDistribution(stats);
          }

          if (analytics.status === 'success') {
            renderRevenue(analytics.data.monthly_stats || []);
          }
        } catch (e) {
          console.error('Error loading admin data', e);
        }
      }

      function renderPendingTable(users) {
        const tbody = document.getElementById('pendingTableBody');
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-4">No pending approvals found.</td></tr>';
          return;
        }
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.name}</td>
            <td class="text-secondary">${user.email}</td>
            <td>
              <span class="badge badge-status ${user.role === 'instructor' ? 'badge-approved' : ''}">${user.role}</span>
            </td>
            <td class="small text-secondary">${new Date(user.created_at).toLocaleDateString()}</td>
            <td><span class="badge badge-status badge-pending">Pending</span></td>
            <td>
              <button class="btn btn-gradient btn-sm" onclick="approveUser(${user.id})"><i class="fas fa-check"></i> Approve</button>
            </td>
          </tr>
        `).join('');
      }

      async function approveUser(userId) {
        if (!confirm('Are you sure you want to approve this user?')) return;
        try {
          const response = await fetch('../backend/admin_actions.php?action=approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
          });
          const result = await response.json();
          if (result.status === 'success') {
            loadAdminData();
          } else {
            alert('Error: ' + (result.message || 'Unexpected'));
          }
        } catch (e) {
          console.error(e);
          alert('Connection Failed');
        }
      }

      function renderRevenue(monthlyStats) {
        // Aggregate by month and map counts to revenue (placeholder multiplier)
        const months = [...new Set(monthlyStats.map(m => m.month))];
        const revenue = months.map(m => {
          const entries = monthlyStats.filter(e => e.month === m);
          const count = entries.reduce((sum, e) => sum + (parseInt(e.count || 0)), 0);
          return count * 12; // simple multiplier to visualize revenue trend
        });

        const ctx = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Revenue',
              data: revenue,
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139,92,246,0.2)',
              tension: 0.35,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f8fafc' } } },
            scales: {
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.18)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
            }
          }
        });

        // Update revenue metric
        const totalRevenue = revenue.reduce((a, b) => a + b, 0);
        document.getElementById('revenueMetric').textContent = '$' + totalRevenue.toLocaleString();
      }

      function renderUserDistribution(stats) {
        const students = parseInt(stats.total_students || 0);
        const instructors = parseInt(stats.total_instructors || 0);
        const ctx = document.getElementById('userDistributionChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Students', 'Instructors'],
            datasets: [{
              data: [students, instructors],
              backgroundColor: ['#3b82f6', '#8b5cf6'],
              borderColor: ['rgba(59,130,246,0.2)', 'rgba(139,92,246,0.2)'],
              hoverOffset: 8
            }]
          },
          options: {
            plugins: {
              legend: { position: 'bottom', labels: { color: '#f8fafc' } }
            }
          }
        });
      }

      // Sidebar active link
      (function setActiveNav(){
        const links = document.querySelectorAll('.sidebar .nav-link');
        links.forEach(a => {
          if (a.getAttribute('href') && location.pathname.endsWith(a.getAttribute('href'))) {
            a.classList.add('active');
          }
        });
      })();

      function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = '../login.html';
      }
    </script>
  </body>
</html>