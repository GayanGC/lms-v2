<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instructor Courses - EduLMS</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="../assets/css/style.css" rel="stylesheet" />
  <link href="../assets/css/modern-theme.css" rel="stylesheet" />

  <style>
    .materials-list::-webkit-scrollbar { width: 4px; }
    .materials-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 4px; }
    .materials-list::-webkit-scrollbar-track { background-color: transparent; }
  </style>
</head>
<body class="dark-app">

  <aside class="sidebar glass d-flex flex-column">
    <div class="brand mb-3">
      <i class="fas fa-chalkboard-teacher text-info"></i>
      <h5 class="m-0" id="instructorName">Instructor</h5>
    </div>
    <nav class="flex-grow-1">
      <a href="./instructor_dashboard.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
      <a href="./instructor_courses.html" class="nav-link active"><i class="fas fa-book"></i> Courses</a>
      <a href="./instructor_profile.html" class="nav-link"><i class="fas fa-id-badge"></i> Profile</a>
    </nav>
    <button class="btn btn-ghost w-100 mt-auto" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </aside>

  <header class="topbar glass">
    <div class="d-flex align-items-center gap-2">
      <span class="gradient-text fw-bold">EduLMS</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <button id="profileTrigger" class="btn btn-outline-light btn-sm rounded-circle d-inline-flex align-items-center justify-content-center" style="width:36px;height:36px">
        <span id="profileInitial" class="fw-bold">I</span>
      </button>
      <img class="avatar" id="avatar" src="" alt="avatar" />
    </div>
  </header>

  <main class="main">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold">My Courses</h2>
        <p class="text-secondary">Create and manage your courses</p>
      </div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCourseModal">
        <i class="fas fa-plus me-2"></i>Create New Course
      </button>
    </div>
    
    <hr class="divider" />
    
    <section>
      <div id="coursesGrid" class="row g-3">
        <div class="col-12"><div class="card-modern p-3"><p class="text-secondary m-0">Loading your courses...</p></div></div>
      </div>
    </section>
  </main>

  <div class="modal fade" id="createCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content glass">
        <div class="modal-header"><h5 class="modal-title">Create New Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="createCourseForm">
            <div class="mb-3"><label>Title</label><input type="text" id="courseTitle" class="form-control" required /></div>
            <div class="mb-3"><label>Description</label><textarea id="courseDesc" class="form-control" rows="3" required></textarea></div>
            <div class="mb-3"><label>Duration</label><select id="courseDuration" class="form-select"><option>4 Weeks</option><option>8 Weeks</option><option>12 Weeks</option></select></div>
            <div class="mb-3"><label>Price</label><input type="number" id="coursePrice" class="form-control" step="0.01" /></div>
            <button type="submit" class="btn btn-primary w-100">Create Course</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content glass">
        <div class="modal-header"><h5 class="modal-title">Upload Material</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="uploadForm">
            <input type="hidden" id="uploadCourseId" name="course_id" />
            <input type="hidden" id="uploadInstructorId" name="instructor_id" />
            <div class="mb-3"><label>Title</label><input type="text" name="title" class="form-control" required /></div>
            <div class="mb-3"><label>PDF File</label><input type="file" name="pdf_file" accept="application/pdf" class="form-control" required /></div>
            <button type="submit" class="btn btn-warning w-100">Upload</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || localStorage.getItem('user'));
    if (!currentUser || currentUser.role !== 'instructor') window.location.href = '../login.html';

    function logout(){ localStorage.clear(); window.location.href = '../login.html'; }

    // User Info
    document.getElementById('instructorName').textContent = currentUser.name;
    document.getElementById('profileInitial').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('avatar').src = currentUser.profile_pic ? `../${currentUser.profile_pic}` : `https://api.dicebear.com/7.x/initials/svg?seed=${currentUser.name}`;

    // Load Courses
    async function loadCourses(){
      const grid = document.getElementById('coursesGrid');
      try {
        const res = await fetch(`../backend/get_my_courses.php?instructor_id=${currentUser.id}`);
        const data = await res.json();
        
        if (data.status === 'success' && data.data.length){
          grid.innerHTML = data.data.map(c => `
            <div class="col-12 col-md-6 col-lg-4">
              <div class="card-modern h-100 p-3 d-flex flex-column">
                <div class="d-flex justify-content-between"><span class="badge text-bg-secondary">${c.duration}</span></div>
                <h5 class="mt-2 mb-1 text-white">${c.title}</h5>
                <p class="text-secondary small flex-grow-1">${c.description}</p>
                <button class="btn btn-sm btn-warning w-100 mt-2" onclick="openUpload(${c.id})"><i class="fas fa-upload"></i> Upload PDF</button>
                
                <div class="mt-3 pt-2 border-top border-secondary border-opacity-25">
                  <small class="text-info fw-bold">Materials:</small>
                  <div id="materialsList_${c.id}" class="mt-1 materials-list" style="max-height:100px; overflow-y:auto;">
                    <small class="text-muted">Loading...</small>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
          
          data.data.forEach(c => loadCourseMaterials(c.id));
        } else {
          grid.innerHTML = '<div class="col-12"><p class="text-secondary">No courses found.</p></div>';
        }
      } catch(e) { console.error(e); }
    }

    // --- IMPORTANT FIX: SMART PATH DETECTION ---
    // This logic prevents the double "assets/uploads" error
    async function loadCourseMaterials(courseId) {
      try {
        const res = await fetch(`../backend/get_materials.php?course_id=${courseId}`);
        const data = await res.json();
        const container = document.getElementById(`materialsList_${courseId}`);
        
        if (data.status === 'success' && data.data.length > 0) {
          container.innerHTML = '';
          data.data.forEach(m => {
            const rawPath = m.file_path || m.filename;
            
            // 1. Get Clean Filename for Display (Just the name, no folders)
            const displayName = rawPath.split('/').pop();

            // 2. Construct Correct URL (Fixes 404 Error)
            let finalUrl = '';
            
            // If the path from DB already contains "assets/uploads/", assume it's a full path
            if (rawPath.includes('assets/uploads/')) {
                // Just go up one level from 'pages' folder
                finalUrl = `../${rawPath}`; 
            } else {
                // If it's just the filename, append the folder path
                finalUrl = `../assets/uploads/${rawPath}`;
            }

            container.innerHTML += `
              <div class="d-flex justify-content-between align-items-center mb-1 p-1" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                <span class="text-truncate text-white-50 small" style="max-width: 150px;" title="${displayName}">
                  <i class="fas fa-file-pdf text-danger me-1"></i> ${displayName}
                </span>
                <a href="${finalUrl}" target="_blank" class="btn btn-sm btn-outline-info p-0 px-2" title="View PDF">
                  <i class="fas fa-eye small"></i>
                </a>
              </div>`;
          });
        } else {
          container.innerHTML = '<small class="text-secondary fst-italic">No materials yet.</small>';
        }
      } catch (e) {
        if(document.getElementById(`materialsList_${courseId}`)) {
            document.getElementById(`materialsList_${courseId}`).innerHTML = '<small class="text-danger">Error.</small>';
        }
      }
    }

    // Modal Handlers
    document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        title: document.getElementById('courseTitle').value,
        description: document.getElementById('courseDesc').value,
        duration: document.getElementById('courseDuration').value,
        price: document.getElementById('coursePrice').value,
        instructor_id: currentUser.id
      };
      await fetch('../backend/create_course.php', { method:'POST', body:JSON.stringify(payload) });
      bootstrap.Modal.getInstance(document.getElementById('createCourseModal')).hide();
      loadCourses();
    });

    function openUpload(id){
      document.getElementById('uploadCourseId').value = id;
      document.getElementById('uploadInstructorId').value = currentUser.id;
      new bootstrap.Modal(document.getElementById('uploadModal')).show();
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await fetch('../backend/upload_material.php', { method:'POST', body:new FormData(e.target) });
      bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
      alert('Uploaded!');
      loadCourseMaterials(document.getElementById('uploadCourseId').value);
    });

    document.addEventListener('DOMContentLoaded', loadCourses);
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/profile-modal.js"></script>
</body>
</html>